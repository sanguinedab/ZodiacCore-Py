# Deploy docs to GitHub Pages with mike (multi-version).
# Trigger: publish a Release. Enable Pages: Settings -> Pages -> Source: Deploy from branch -> gh-pages.

name: Deploy Docs

on:
  release:
    types: [published]

permissions:
  contents: write

jobs:
  deploy-docs:
    name: Deploy to GitHub Pages
    runs-on: ubuntu-latest
    steps:
      - name: Checkout tag
        uses: actions/checkout@v4
        with:
          ref: ${{ github.ref }}

      - name: Set version
        run: echo "VERSION=${GITHUB_REF_NAME#v}" >> $GITHUB_ENV

      - name: Install uv
        uses: astral-sh/setup-uv@v5
        with:
          enable-cache: true

      - name: Install dependencies
        run: uv sync --group docs

      - name: Sync CHANGELOG to docs
        run: make docs-sync

      - name: Configure git for mike push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git remote set-url origin "https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git"

      # CI does a shallow clone; fetch gh-pages so mike can push on top of latest remote (mike README).
      - name: Fetch gh-pages
        run: git fetch origin gh-pages --depth=1 || true

      - name: Deploy version and set latest
        run: |
          uv run mike deploy --push --update-aliases "${{ env.VERSION }}" latest
          uv run mike set-default --push latest
